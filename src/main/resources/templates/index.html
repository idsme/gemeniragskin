<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini RAG Skin</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <h1>Solution Architect Agent - please review my project</h1>
        <p class="subtitle">Query your project documentation with AI</p>
    </header>

    <main class="container">
        <!-- API Warning -->
        <div th:if="${!apiConfigured}" class="message message-warning">
            <strong>Warning:</strong> Gemini API key not configured. Set the GEMINI_API_KEY environment variable.
        </div>

        <!-- Global Messages -->
        <div th:if="${error}" class="message message-error" th:text="${error}"></div>

        <!-- File Upload Section -->
        <section class="section upload-section">
            <h2 class="section-title">Upload Files</h2>
            <form th:action="@{/upload}" method="post" enctype="multipart/form-data" class="upload-form">
                <div class="upload-area" id="dropZone">
                    <div class="upload-icon">üìÅ</div>
                    <p>Drag and drop files here, or click to select</p>
                    <p class="upload-hint">Supported formats: PDF, Word (.doc, .docx), TXT, MD (Max 50MB per file)</p>
                    <input type="file" id="fileInput" name="files" multiple
                           accept=".pdf,.doc,.docx,.txt,.md"
                           aria-label="Select files to upload"
                           onchange="updateFileList(this)">
                </div>
                <div id="selectedFiles" class="selected-files"></div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="uploadBtn">Upload Files</button>
                </div>
                <div th:if="${uploadSuccess}" class="message message-success" th:text="${uploadSuccess}"></div>
                <div th:if="${uploadError}" class="message message-error" th:text="${uploadError}"></div>
            </form>
        </section>

        <!-- File List Section -->
        <section class="section files-section">
            <h2 class="section-title">Uploaded Files</h2>
            <div th:if="${!hasFiles}" class="empty-state">
                <p>No files uploaded yet</p>
            </div>
            <ul th:if="${hasFiles}" class="file-list">
                <li th:each="file : ${files}" class="file-item">
                    <span th:class="'file-icon ' + ${file.iconClass}" aria-hidden="true"></span>
                    <span class="file-name" th:text="${file.name}"></span>
                    <span class="file-size" th:text="${file.displaySize}"></span>
                    <form th:action="@{/delete/{id}(id=${file.id})}" method="post" class="delete-form">
                        <button type="submit" class="btn btn-danger btn-small"
                                th:aria-label="'Delete ' + ${file.name}">Delete</button>
                    </form>
                </li>
            </ul>
            <div th:if="${deleteSuccess}" class="message message-success" th:text="${deleteSuccess}"></div>
            <div th:if="${deleteError}" class="message message-error" th:text="${deleteError}"></div>
        </section>

        <!-- Config Section -->
        <section class="section config-section">
            <h2 class="section-title">Configuration</h2>
            <form th:action="@{/config/save}" method="post" class="config-form" id="configForm">
                <!-- System Prompts Section -->
                <h3 class="subsection-title">System Prompts</h3>
                <div id="systemPromptsContainer">
                    <div class="form-group system-prompt-group" th:each="systemPrompt, iterStat : ${allSystemPrompts}">
                        <div class="system-prompt-header">
                            <input type="radio"
                                   th:id="'systemPromptRadio' + ${iterStat.count}"
                                   name="selectedSystemPrompt"
                                   th:value="${iterStat.count}"
                                   th:checked="${iterStat.count == selectedSystemPromptIndex}"
                                   th:aria-label="'Select system prompt ' + ${iterStat.count}">
                            <label th:for="'systemPromptRadio' + ${iterStat.count}"
                                   class="radio-label"
                                   th:text="'System Prompt ' + ${iterStat.count}"></label>
                            <button type="button" class="btn-icon btn-delete-system-prompt"
                                    onclick="deleteSystemPrompt(this)"
                                    th:aria-label="'Delete system prompt ' + ${iterStat.count}"
                                    title="Delete this system prompt">
                                üóëÔ∏è
                            </button>
                        </div>
                        <textarea th:id="'systemPrompt' + ${iterStat.count}"
                                  th:name="'systemPrompt' + ${iterStat.count}"
                                  rows="4"
                                  th:text="${systemPrompt}"></textarea>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="addNewSystemPrompt()">Add System Prompt</button>
                </div>

                <!-- Architecture Prompts Section -->
                <h3 class="subsection-title">Architecture Prompts</h3>
                <div id="promptsContainer">
                    <div class="form-group prompt-group" th:each="prompt, iterStat : ${allPrompts}">
                        <label th:for="'prompt' + ${iterStat.count}" th:text="'Prompt ' + ${iterStat.count}"></label>
                        <div class="prompt-input-wrapper">
                            <textarea th:id="'prompt' + ${iterStat.count}"
                                      th:name="'prompt' + ${iterStat.count}"
                                      rows="3"
                                      th:text="${prompt}"></textarea>
                            <button type="button" class="btn-icon btn-delete-prompt"
                                    onclick="deletePrompt(this)"
                                    th:aria-label="'Delete prompt ' + ${iterStat.count}"
                                    title="Delete this prompt">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="addNewPrompt()">Add Architecture Prompt</button>
                    <button type="submit" class="btn btn-primary">Save Configuration</button>
                </div>
                <div th:if="${configSuccess}" class="message message-success" th:text="${configSuccess}"></div>
                <div th:if="${configError}" class="message message-error" th:text="${configError}"></div>
            </form>
        </section>

        <!-- Search Section -->
        <section class="section search-section">
            <h2 class="section-title">Search Documents</h2>
            <div class="prompt-selection-list">
                <div class="prompt-selection-item" th:each="prompt, iterStat : ${allPrompts}">
                    <input type="checkbox"
                           th:id="'promptCheck' + ${iterStat.count}"
                           class="prompt-checkbox"
                           th:data-prompt="${prompt}"
                           th:disabled="${!hasFiles}">
                    <label th:for="'promptCheck' + ${iterStat.count}"
                           class="prompt-checkbox-label"
                           th:text="${prompt}"></label>
                </div>
            </div>
            <div class="prompt-selection-actions">
                <button type="button" class="btn btn-primary" id="executePromptsBtn"
                        onclick="executeSelectedPrompts()"
                        th:disabled="${!hasFiles}"
                        th:title="${hasFiles ? 'Execute selected prompts' : 'Upload files first'}">
                    Execute Selected Prompts
                </button>
            </div>
            <form th:action="@{/search}" method="post" class="search-form">
                <div class="search-input-group">
                    <label for="searchQuery" class="sr-only">Search Query</label>
                    <input type="text" id="searchQuery" name="query"
                           placeholder="Enter your question about the uploaded documents..."
                           th:disabled="${!hasFiles}">
                    <button type="submit" class="btn btn-primary" id="searchBtn"
                            th:disabled="${!hasFiles}"
                            th:title="${hasFiles ? 'Search' : 'Upload files first'}">
                        Search
                    </button>
                </div>
                <div th:if="${searchError}" class="message message-error" th:text="${searchError}"></div>
            </form>
        </section>

        <!-- Results Section -->
        <section class="section results-section">
            <h2 class="section-title">Results</h2>
            <div th:if="${!hasSearchResults}" class="empty-state">
                <p>No searches performed yet. Upload files and ask a question to get started.</p>
            </div>
            <div th:if="${hasSearchResults}" class="results-list">
                <article th:each="result : ${searchResults}" class="result-item">
                    <div class="result-header">
                        <span class="result-query" th:text="${result.query}"></span>
                        <span class="result-timestamp" th:text="${result.formattedTimestamp}"></span>
                    </div>
                    <div class="result-response" th:utext="${result.responseHtml}"></div>
                    <div th:if="${!result.citations.isEmpty()}" class="result-citations">
                        <strong>Sources:</strong>
                        <span th:each="citation, iterStat : ${result.citations}">
                            <span th:text="${citation}"></span><span th:if="${!iterStat.last}">, </span>
                        </span>
                    </div>
                </article>
            </div>
        </section>

        <!-- Demo Project Summary Section -->
        <section class="section demo-project-section">
            <h2 class="section-title">Demo Project Summary</h2>
            <p class="section-description">Enter a comprehensive product requirement description to upload as a text document to the knowledge base.</p>
            <form th:action="@{/upload-text}" method="post" class="demo-project-form">
                <div class="form-group">
                    <label for="projectDescription" class="sr-only">Project Description</label>
                    <textarea id="projectDescription" name="projectDescription" rows="15"
                              placeholder="Enter your project description here (max 500 words)...&#10;&#10;Include:&#10;- Summary&#10;- Requirements (Frontend, Backend, Database, Stack)&#10;- Financials&#10;- Goal&#10;- Situation&#10;- Problem&#10;- Solution approach"
                              maxlength="5000"
                              required></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="sendProjectBtn">Send to Knowledge Base</button>
                </div>
                <div th:if="${textUploadSuccess}" class="message message-success" th:text="${textUploadSuccess}"></div>
                <div th:if="${textUploadError}" class="message message-error" th:text="${textUploadError}"></div>
            </form>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <p>Gemini RAG Skin &mdash; Powered by Google Gemini</p>
    </footer>

    <script>
        // Drag and drop handling
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        if (dropZone) {
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-over');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                fileInput.files = e.dataTransfer.files;
                updateFileList(fileInput);
            });

            dropZone.addEventListener('click', () => {
                fileInput.click();
            });
        }

        // Update selected files display
        function updateFileList(input) {
            const container = document.getElementById('selectedFiles');
            container.innerHTML = '';
            if (input.files.length > 0) {
                const list = document.createElement('ul');
                for (const file of input.files) {
                    const li = document.createElement('li');
                    li.textContent = `${file.name} (${formatSize(file.size)})`;
                    list.appendChild(li);
                }
                container.appendChild(list);
            }
        }

        // Format file size
        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Execute selected prompts (multiple queries)
        function executeSelectedPrompts() {
            const checkboxes = document.querySelectorAll('.prompt-checkbox:checked');

            if (checkboxes.length === 0) {
                alert('Please select at least one prompt to execute.');
                return;
            }

            // Collect all selected prompts
            const selectedPrompts = [];
            checkboxes.forEach(checkbox => {
                selectedPrompts.push(checkbox.getAttribute('data-prompt'));
            });

            // Submit each prompt as a separate search query
            let completedQueries = 0;
            selectedPrompts.forEach((prompt, index) => {
                setTimeout(() => {
                    // Create a hidden form to submit the query
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/search';

                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'query';
                    input.value = prompt;

                    form.appendChild(input);
                    document.body.appendChild(form);
                    form.submit();
                }, index * 100); // Small delay between submissions
            });
        }

        // Add new system prompt field
        function addNewSystemPrompt() {
            const container = document.getElementById('systemPromptsContainer');
            const promptCount = container.querySelectorAll('.form-group').length + 1;

            const formGroup = document.createElement('div');
            formGroup.className = 'form-group system-prompt-group';

            const header = document.createElement('div');
            header.className = 'system-prompt-header';

            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.id = 'systemPromptRadio' + promptCount;
            radio.name = 'selectedSystemPrompt';
            radio.value = promptCount;
            radio.setAttribute('aria-label', 'Select system prompt ' + promptCount);

            const label = document.createElement('label');
            label.setAttribute('for', 'systemPromptRadio' + promptCount);
            label.className = 'radio-label';
            label.textContent = 'System Prompt ' + promptCount;

            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'btn-icon btn-delete-system-prompt';
            deleteBtn.onclick = function() { deleteSystemPrompt(this); };
            deleteBtn.setAttribute('aria-label', 'Delete system prompt ' + promptCount);
            deleteBtn.setAttribute('title', 'Delete this system prompt');
            deleteBtn.textContent = 'üóëÔ∏è';

            header.appendChild(radio);
            header.appendChild(label);
            header.appendChild(deleteBtn);

            const textarea = document.createElement('textarea');
            textarea.id = 'systemPrompt' + promptCount;
            textarea.name = 'systemPrompt' + promptCount;
            textarea.rows = 4;
            textarea.value = '';

            formGroup.appendChild(header);
            formGroup.appendChild(textarea);
            container.appendChild(formGroup);
        }

        // Delete system prompt field
        function deleteSystemPrompt(button) {
            const container = document.getElementById('systemPromptsContainer');
            const promptGroup = button.closest('.system-prompt-group');

            // Don't allow deletion if it's the only system prompt
            if (container.querySelectorAll('.system-prompt-group').length <= 1) {
                alert('You must have at least one system prompt.');
                return;
            }

            if (promptGroup) {
                // Check if this is the selected prompt
                const radio = promptGroup.querySelector('input[type="radio"]');
                const wasSelected = radio && radio.checked;

                promptGroup.remove();

                // Renumber remaining prompts
                renumberSystemPrompts();

                // If the deleted prompt was selected, select the first one
                if (wasSelected) {
                    const firstRadio = container.querySelector('input[type="radio"]');
                    if (firstRadio) {
                        firstRadio.checked = true;
                    }
                }
            }
        }

        // Renumber system prompts after deletion
        function renumberSystemPrompts() {
            const container = document.getElementById('systemPromptsContainer');
            const promptGroups = container.querySelectorAll('.system-prompt-group');

            promptGroups.forEach((group, index) => {
                const newNumber = index + 1;
                const radio = group.querySelector('input[type="radio"]');
                const label = group.querySelector('.radio-label');
                const textarea = group.querySelector('textarea');
                const deleteBtn = group.querySelector('.btn-delete-system-prompt');

                if (radio) {
                    radio.id = 'systemPromptRadio' + newNumber;
                    radio.value = newNumber;
                    radio.setAttribute('aria-label', 'Select system prompt ' + newNumber);
                }
                if (label) {
                    label.textContent = 'System Prompt ' + newNumber;
                    label.setAttribute('for', 'systemPromptRadio' + newNumber);
                }
                if (textarea) {
                    textarea.id = 'systemPrompt' + newNumber;
                    textarea.name = 'systemPrompt' + newNumber;
                }
                if (deleteBtn) {
                    deleteBtn.setAttribute('aria-label', 'Delete system prompt ' + newNumber);
                }
            });
        }

        // Add new architecture prompt field
        function addNewPrompt() {
            const container = document.getElementById('promptsContainer');
            const promptCount = container.querySelectorAll('.form-group').length + 1;

            const formGroup = document.createElement('div');
            formGroup.className = 'form-group prompt-group';

            const label = document.createElement('label');
            label.setAttribute('for', 'prompt' + promptCount);
            label.textContent = 'Prompt ' + promptCount;

            const wrapper = document.createElement('div');
            wrapper.className = 'prompt-input-wrapper';

            const textarea = document.createElement('textarea');
            textarea.id = 'prompt' + promptCount;
            textarea.name = 'prompt' + promptCount;
            textarea.rows = 3;
            textarea.value = '';

            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'btn-icon btn-delete-prompt';
            deleteBtn.onclick = function() { deletePrompt(this); };
            deleteBtn.setAttribute('aria-label', 'Delete prompt ' + promptCount);
            deleteBtn.setAttribute('title', 'Delete this prompt');
            deleteBtn.textContent = 'üóëÔ∏è';

            wrapper.appendChild(textarea);
            wrapper.appendChild(deleteBtn);
            formGroup.appendChild(label);
            formGroup.appendChild(wrapper);
            container.appendChild(formGroup);
        }

        // Delete architecture prompt field
        function deletePrompt(button) {
            const promptGroup = button.closest('.prompt-group');
            if (promptGroup) {
                promptGroup.remove();
                // Renumber remaining prompts
                renumberPrompts();
            }
        }

        // Renumber architecture prompts after deletion
        function renumberPrompts() {
            const container = document.getElementById('promptsContainer');
            const promptGroups = container.querySelectorAll('.prompt-group');

            promptGroups.forEach((group, index) => {
                const newNumber = index + 1;
                const label = group.querySelector('label');
                const textarea = group.querySelector('textarea');
                const deleteBtn = group.querySelector('.btn-delete-prompt');

                if (label) {
                    label.textContent = 'Prompt ' + newNumber;
                    label.setAttribute('for', 'prompt' + newNumber);
                }
                if (textarea) {
                    textarea.id = 'prompt' + newNumber;
                    textarea.name = 'prompt' + newNumber;
                }
                if (deleteBtn) {
                    deleteBtn.setAttribute('aria-label', 'Delete prompt ' + newNumber);
                }
            });
        }

        // Prevent double submission
        document.querySelectorAll('form').forEach(form => {
            form.addEventListener('submit', function() {
                const btn = form.querySelector('button[type="submit"]');
                if (btn) {
                    btn.disabled = true;
                    btn.classList.add('loading');
                }
            });
        });
    </script>
</body>
</html>
